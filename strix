#!/bin/bash

VERSION="1.0.0"

# Function to display help information
function show_help() {
    echo "Strix OS Package Manager v$VERSION"
    echo "Usage: strix [command] [options]"
    echo ""
    echo "Commands:"
    echo "  install <module>     Install a specific module"
    echo "  uninstall <module>   Remove a specific module"
    echo "  update               Update Strix OS and its modules"
    echo "  list                 List all available modules"
    echo "  search <keyword>     Search for modules by keyword"
    echo "  status <module>      Check the status of a module"
    echo "  version              Display the version of Strix OS"
    echo "  help                 Show this help message"
    echo ""
    echo "Example: strix install kali-tools"
}

# Function to fetch updates from GitHub
function update_from_github() {
    echo "Fetching updates from GitHub..."
    cd ~/strix-os
    git pull origin main
    echo "Strix OS has been updated to the latest version."
}

# Function to install a module from GitHub
function install_module() {
    MODULE=$1
    echo "Installing $MODULE..."
    
    # Check if module exists
    if [ ! -d ~/strix-os/modules/$MODULE ]; then
        echo "Error: Module '$MODULE' not found."
        echo "Use 'strix list' to see available modules."
        return 1
    fi
    
    # Check if install script exists
    if [ ! -f ~/strix-os/modules/$MODULE/install.sh ]; then
        echo "Error: Installation script for '$MODULE' not found."
        return 1
    fi
    
    # Run the module's install script
    bash ~/strix-os/modules/$MODULE/install.sh
    
    # Call the strix manager to register the module
    bash ~/strix-os/modules/strix-manager.sh register $MODULE
}

# Function to uninstall a module
function uninstall_module() {
    MODULE=$1
    echo "Uninstalling $MODULE..."
    
    # Check if module exists
    if [ ! -d ~/strix-os/modules/$MODULE ]; then
        echo "Error: Module '$MODULE' not found."
        return 1
    fi
    
    # Check if uninstall script exists
    if [ -f ~/strix-os/modules/$MODULE/uninstall.sh ]; then
        bash ~/strix-os/modules/$MODULE/uninstall.sh
    else
        echo "Warning: No uninstall script found. Attempting generic uninstall..."
        bash ~/strix-os/modules/strix-manager.sh unregister $MODULE
    fi
}

# Function to search for modules
function search_modules() {
    KEYWORD=$1
    echo "Searching for modules matching '$KEYWORD'..."
    grep -l "$KEYWORD" ~/strix-os/modules/*/info.txt 2>/dev/null | sed 's|.*/\([^/]*\)/info.txt|\1|'
}

# Function to check module status
function check_module_status() {
    MODULE=$1
    echo "Checking status of $MODULE..."
    bash ~/strix-os/modules/strix-manager.sh status $MODULE
}

# Command actions
case "$1" in
    install)
        if [ -z "$2" ]; then
            echo "Please specify a module to install."
            echo "Usage: strix install <module>"
        else
            install_module $2
        fi
        ;;
    uninstall)
        if [ -z "$2" ]; then
            echo "Please specify a module to uninstall."
            echo "Usage: strix uninstall <module>"
        else
            uninstall_module $2
        fi
        ;;
    update)
        update_from_github
        ;;
    list)
        echo "Listing available modules:"
        ls ~/strix-os/modules
        ;;
    search)
        if [ -z "$2" ]; then
            echo "Please specify a search term."
            echo "Usage: strix search <keyword>"
        else
            search_modules $2
        fi
        ;;
    status)
        if [ -z "$2" ]; then
            echo "Please specify a module to check."
            echo "Usage: strix status <module>"
        else
            check_module_status $2
        fi
        ;;
    version)
        echo "Strix OS v$VERSION"
        ;;
    help)
        show_help
        ;;
    *)
        show_help
        ;;
esac
